(()=>{"use strict";class e{constructor(e,t,s,r,i,n){this._name=e.name,this._link=e.link,this._templateSelector=s,this._handleClickCard=r,this._handleDeleteCard=i,this._handleLikeCard=n,this._currentUser=t,this._cardOwner=e.owner._id,this._id=e._id,this.likes=e.likes}checkLike(){return this.likes.some((e=>e._id===this._currentUser))}_setLikeState(){this.checkLike()?this.setLike():this.removeLike()}setLike(){this._cardLike.classList.add("elements__like-button_active"),this._cardLikeCounter.textContent=this.likes.length}removeLike(){this._cardLike.classList.remove("elements__like-button_active"),this._cardLikeCounter.textContent=this.likes.length}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".elements__element").cloneNode(!0)}generateCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".elements__image"),this._cardCaption=this._element.querySelector(".elements__place"),this._cardLike=this._element.querySelector(".elements__like-button"),this._cardLikeCounter=this._element.querySelector(".elements__like-meter"),this._cardDelete=this._element.querySelector(".elements__delete-button"),this._cardImage.src=this._link,this._cardImage.alt=this._name,this._cardCaption.textContent=this._name,this._cardOwner!==this._currentUser&&this._cardDelete.remove(),this._setLikeState(),this._setEventListeners(),this._element}deleteCard(){this._element.remove(),this._element=null}_setEventListeners(){this._cardLike.addEventListener("click",(()=>{this._handleLikeCard(this)})),this._cardDelete.addEventListener("click",(()=>{this._handleDeleteCard(this)})),this._cardImage.addEventListener("click",(()=>{this._handleClickCard(this._name,this._link)}))}}class t{constructor(e,t){this._inputSelector=e.inputSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formElement=document.querySelector(t),this._inputList=Array.from(this._formElement.querySelectorAll(this._inputSelector)),this._submitButton=this._formElement.querySelector(e.submitButtonSelector)}_showInputError(e,t){const s=this._formElement.querySelector(`.${e.id}-error`);e.classList.add(this._inputErrorClass),s.textContent=t,s.classList.add(this._errorClass)}_hideInputError(e){const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.remove(this._inputErrorClass),t.classList.remove(this._errorClass),t.textContent=""}_validateInput(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}toggleButtonState(){this._hasInvalidInput()?(this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.setAttribute("disabled","true")):(this._submitButton.classList.remove(this._inactiveButtonClass),this._submitButton.removeAttribute("disabled"))}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._validateInput(e),this.toggleButtonState()}))}))}resetValidation(){this._inputList.forEach((e=>{this._hideInputError(e)}))}enableValidation(){this._formElement.addEventListener("submit",(e=>{e.preventDefault()})),this._setEventListeners()}}class s{constructor(e){this._popup=document.querySelector(e),this._closeButton=this._popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this),this._handleOverlayClose=this._handleOverlayClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(e){e.target.classList.contains("popup_opened")&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",this._handleOverlayClose),this._closeButton.addEventListener("click",(()=>this.close()))}}class r extends s{constructor({popupSelector:e,submitCallback:t}){super(e),this._inputList=this._popup.querySelectorAll(".form__input"),this._submitButton=this._popup.querySelector(".form__save-button"),this._form=this._popup.querySelector(".form"),this._submitCallback=t}setPending(){this._submitButton.textContent="Сохранение..."}removePending(e){this._submitButton.textContent=e}_getInputValues(){return this._inputValues={},this._inputList.forEach((e=>{this._inputValues[e.name]=e.value})),this._inputValues}setInputValues(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitCallback(this._getInputValues())})),super.setEventListeners()}close(){super.close(),setTimeout((()=>{this._form.reset()}),300)}}const i=document.querySelector("#add-button"),n=document.querySelector("#edit-button"),o=document.querySelector(".profile__avatar-edit-button"),a={inputSelector:".form__input",submitButtonSelector:".form__save-button",inactiveButtonClass:"form__save-button_disabled",inputErrorClass:"form__input_error-type",errorClass:"form__error_visible"};let l="",h="";const c=new class{constructor(e){this._url=e.url,this._headers=e.headers}_checkErorr(e){return e.ok?e.json():Promise.reject("Ошибка"+e.status)}getCardList(){return fetch(`${this._url}cards`,{method:"GET",headers:this._headers}).then(this._checkErorr)}addCard(e){return fetch(`${this._url}cards`,{method:"POST",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}deleteCard(e){return fetch(`${this._url}cards/${e}`,{method:"DELETE",headers:this._headers}).then(this._checkErorr)}getUserInfo(){return fetch(`${this._url}users/me`,{method:"GET",headers:this._headers}).then(this._checkErorr)}changeUserInfo(e){return fetch(`${this._url}users/me`,{method:"PATCH",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}changeAvatar(e){return fetch(`${this._url}users/me/avatar`,{method:"PATCH",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}likeCard(e){return fetch(`${this._url}cards/${e}/likes`,{method:"PUT",headers:this._headers}).then(this._checkErorr)}removeLike(e){return fetch(`${this._url}cards/${e}/likes`,{method:"DELETE",headers:this._headers}).then(this._checkErorr)}}({url:"https://mesto.nomoreparties.co/v1/cohort-41/",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b"}}),u=new class{constructor({nameSelector:e,aboutSelector:t,avatarSelector:s,_id:r}){this._name=document.querySelector(e),this._about=document.querySelector(t),this._avatar=document.querySelector(s),this._nameInput=document.querySelector(`${e}-input`),this._aboutInput=document.querySelector(`${t}-input`),this._id=r}setAvatar(e){this._avatar.src=e.avatar}setUserInfo(e){this._name.textContent=e.name,this._about.textContent=e.about,this._id=e._id}setId(e){this._id=e}getInfo(){return{name:this._name.textContent,nameInput:this._nameInput.value,about:this._about.textContent,aboutInput:this._about.textContent,_id:this._id}}getId(e){return this._id}}({nameSelector:"#name",aboutSelector:"#about",avatarSelector:"#avatar",id:"a97c5a8fdf6401cef9281092"}),_=new class{constructor(e,t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}((e=>{_.addItem(d(e,l))}),".elements");function d(t,s){return new e(t,s,"#card",(()=>p.open({name:t.name,link:t.link})),(e=>m.open(e)),(e=>{e.checkLike()?c.removeLike(t._id).then((t=>e.likes=t.likes)).then((()=>e.removeLike())).catch((e=>console.log(e))):c.likeCard(t._id).then((t=>e.likes=t.likes)).then((()=>e.setLike())).catch((e=>console.log(e)))})).generateCard()}const p=new class extends s{constructor(e){super(e),this._popupName=this._popup.querySelector(".popup__name"),this._popupImage=this._popup.querySelector(".popup__image")}open({name:e,link:t}){this._popupName.textContent=e,this._popupImage.src=t,this._popupImage.alt=e,super.open()}}("#popup-card");p.setEventListeners();const m=new class extends s{constructor({popupSelector:e,submitCallback:t}){super(e),this._submitButton=this._popup.querySelector(".popup__save-button"),this._submitCallback=t}open(e){this.card=e,super.open()}setEventListeners(){this._submitButton.addEventListener("click",(()=>{this._submitCallback()})),super.setEventListeners()}}({popupSelector:"#popup-agreement",submitCallback:()=>{c.deleteCard(m.card._id).then((()=>m.card.deleteCard())).then((()=>m.close())).catch((e=>console.log(e)))}});m.setEventListeners();const v=new r({popupSelector:"#popup-profile",submitCallback:e=>{v.setPending(),c.changeUserInfo(e).then((e=>{u.setUserInfo(e),v.close()})).catch((e=>console.log(e))).finally((()=>v.removePending("Сохранить")))}});v.setEventListeners(),n.addEventListener("click",(()=>{v.setInputValues(u.getInfo(u.name,u.about)),E.resetValidation(),E.toggleButtonState(),v.open()}));const k=new r({popupSelector:"#popup-avatar",submitCallback:e=>{k.setPending(),c.changeAvatar({avatar:e.avatar}).then((()=>{u.setAvatar({avatar:e.avatar}),k.close()})).catch((e=>console.log(e))).finally((()=>k.removePending("Сохранить")))}});k.setEventListeners(),o.addEventListener("click",(()=>{L.resetValidation(),L.toggleButtonState(),k.open()}));const b=new r({popupSelector:"#popup-place",submitCallback:e=>{b.setPending(),c.addCard(e).then((e=>{_.addItem(d(e,h)),b.close()})).catch((e=>console.log(e))).finally((()=>b.removePending("Создать")))}});b.setEventListeners(),i.addEventListener("click",(()=>{C.resetValidation(),C.toggleButtonState(),b.open()}));const C=new t(a,"#place-form");C.enableValidation();const E=new t(a,"#profile-form");E.enableValidation();const L=new t(a,"#avatar-form");L.enableValidation(),Promise.all([c.getUserInfo(),c.getCardList()]).then((e=>{h=e[0]._id,u.setAvatar(e[0]),u.setUserInfo(e[0]),l=u.getId(e[0]._id),_.renderItems(e[1].reverse())})).catch((e=>console.log(e)))})();