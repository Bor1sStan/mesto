(()=>{"use strict";class e{constructor(e,t,s,r,i,n){this._name=e.name,this._link=e.link,this._templateSelector=s,this._handleClickCard=r,this._handleDeleteCard=i,this._handleLikeCard=n,this._currentUser=t,this._cardOwner=e.owner._id,this._id=e._id,this.likes=e.likes}checkLike(){return this.likes.some((e=>e._id===this._currentUser))}_setLikeState(){this.checkLike()?this.setLike():this.removeLike()}setLike(){this._cardLike.classList.add("elements__like-button_active"),this._cardLikeCounter.textContent=this.likes.length}removeLike(){this._cardLike.classList.remove("elements__like-button_active"),this._cardLikeCounter.textContent=this.likes.length}_getTemplate(){return document.querySelector(this._templateSelector).content.querySelector(".elements__element").cloneNode(!0)}generateCard(){return this._element=this._getTemplate(),this._cardImage=this._element.querySelector(".elements__image"),this._cardCaption=this._element.querySelector(".elements__place"),this._cardLike=this._element.querySelector(".elements__like-button"),this._cardLikeCounter=this._element.querySelector(".elements__like-meter"),this._cardDelete=this._element.querySelector(".elements__delete-button"),this._cardImage.src=this._link,this._cardImage.alt=this._name,this._cardCaption.textContent=this._name,this._cardOwner!==this._currentUser&&this._cardDelete.remove(),this._setLikeState(),this._setEventListeners(),this._element}deleteCard(){this._element.remove()}_setEventListeners(){this._cardLike.addEventListener("click",(()=>{this._handleLikeCard(this)})),this._cardDelete.addEventListener("click",(()=>{this._handleDeleteCard(this)})),this._cardImage.addEventListener("click",(()=>{this._handleClickCard(this._name,this._link)}))}}class t{constructor(e,t){this._inputSelector=e.inputSelector,this._inactiveButtonClass=e.inactiveButtonClass,this._inputErrorClass=e.inputErrorClass,this._errorClass=e.errorClass,this._formElement=document.querySelector(t),this._inputList=Array.from(this._formElement.querySelectorAll(this._inputSelector)),this._submitButton=this._formElement.querySelector(e.submitButtonSelector)}_showInputError(e,t){const s=this._formElement.querySelector(`.${e.id}-error`);e.classList.add(this._inputErrorClass),s.textContent=t,s.classList.add(this._errorClass)}_hideInputError(e){const t=this._formElement.querySelector(`.${e.id}-error`);e.classList.remove(this._inputErrorClass),t.classList.remove(this._errorClass),t.textContent=""}_validateInput(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}toggleButtonState(){this._hasInvalidInput()?(this._submitButton.classList.add(this._inactiveButtonClass),this._submitButton.setAttribute("disabled","true")):(this._submitButton.classList.remove(this._inactiveButtonClass),this._submitButton.removeAttribute("disabled"))}_setEventListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._validateInput(e),this.toggleButtonState()}))}))}resetValidation(){this._inputList.forEach((e=>{this._hideInputError(e)}))}enableValidation(){this._formElement.addEventListener("submit",(e=>{e.preventDefault()})),this._setEventListeners()}}class s{constructor(e){this._popup=document.querySelector(e),this._closeButton=this._popup.querySelector(".popup__close-button"),this._handleEscClose=this._handleEscClose.bind(this),this._handleOverlayClose=this._handleOverlayClose.bind(this)}open(){this._popup.classList.add("popup_opened"),document.addEventListener("keydown",this._handleEscClose)}close(){this._popup.classList.remove("popup_opened"),document.removeEventListener("keydown",this._handleEscClose)}_handleEscClose(e){"Escape"===e.key&&this.close()}_handleOverlayClose(e){e.target.classList.contains("popup_opened")&&this.close()}setEventListeners(){this._popup.addEventListener("mousedown",this._handleOverlayClose),this._closeButton.addEventListener("click",(()=>this.close()))}}class r extends s{constructor({popupSelector:e,submitCallback:t}){super(e),this._inputList=this._popup.querySelectorAll(".form__input"),this._submitButton=this._popup.querySelector(".form__save-button"),this._form=this._popup.querySelector(".form"),this._submitCallback=t}setPending(){this._submitButton.textContent="Сохранение..."}removePending(e){this._submitButton.textContent=e}_getInputValues(){return this._inputValues={},this._inputList.forEach((e=>{this._inputValues[e.name]=e.value})),this._inputValues}setInputValues(e){this._inputList.forEach((t=>{t.value=e[t.name]}))}setEventListeners(){this._form.addEventListener("submit",(e=>{e.preventDefault(),this._submitCallback(this._getInputValues())})),super.setEventListeners()}close(){super.close(),this._form.reset()}}const i=document.querySelector("#add-button"),n=document.querySelector("#edit-button"),a=document.querySelector(".profile__avatar-edit-button"),o={inputSelector:".form__input",submitButtonSelector:".form__save-button",inactiveButtonClass:"form__save-button_disabled",inputErrorClass:"form__input_error-type",errorClass:"form__error_visible"},l=new class{constructor(e){this._url=e.url,this._headers=e.headers}_checkErorr(e){return e.ok?e.json():Promise.reject("Ошибка"+e.status)}getCardList(){return fetch(`${this._url}cards`,{method:"GET",headers:this._headers}).then(this._checkErorr)}addCard(e){return fetch(`${this._url}cards`,{method:"POST",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}deleteCard(e){return fetch(`${this._url}cards/${e}`,{method:"DELETE",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b"}}).then(this._checkErorr)}getUserInfo(){return fetch(`${this._url}users/me`,{method:"GET",headers:this._headers}).then(this._checkErorr)}changeUserInfo(e){return fetch(`${this._url}users/me`,{method:"PATCH",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}changeAvatar(e){return fetch(`${this._url}users/me/avatar`,{method:"PATCH",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b","Content-Type":"application/json"},body:JSON.stringify(e)}).then(this._checkErorr)}likeCard(e){return fetch(`${this._url}cards/${e}/likes`,{method:"PUT",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b"}}).then(this._checkErorr)}removeLike(e){return fetch(`${this._url}cards/${e}/likes`,{method:"DELETE",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b"}}).then(this._checkErorr)}}({url:"https://mesto.nomoreparties.co/v1/cohort-41/",headers:{authorization:"5ac24e56-6009-4399-abe6-aadfc281115b"}}),c=new class{constructor({nameSelector:e,aboutSelector:t,avatarSelector:s,api:r}){this._name=document.querySelector(e),this._nameInput=document.querySelector(`${e}-input`),this._about=document.querySelector(t),this._aboutInput=document.querySelector(`${t}-input`),this._avatar=document.querySelector(s),this._api=r}getInfo(){return{name:this._nameInput.value,about:this._aboutInput.value,avatar:this._avatar.src}}setAvatar(e){this._avatar.src=e.avatar}setUserInfo({name:e,about:t}){this._name.textContent=e,this._nameInput.textContent=e,this._about.textContent=t,this._aboutInput.textContent=t}}({nameSelector:"#name",aboutSelector:"#about",avatarSelector:"#avatar",api:l}),h=new class{constructor(e,t){this._renderer=e,this._container=document.querySelector(t)}renderItems(e){e.forEach((e=>{this._renderer(e)}))}addItem(e){this._container.prepend(e)}}((e=>{h.addItem(u(e,"a97c5a8fdf6401cef9281092"))}),".elements");function u(t,s){return new e(t,s,"#card",(()=>_.open({name:t.name,link:t.link})),(e=>d.open(e)),(e=>{e.checkLike()?l.removeLike(t._id).then((t=>e.likes=t.likes)).then((()=>e.removeLike())):l.likeCard(t._id).then((t=>e.likes=t.likes)).then((()=>e.setLike()))})).generateCard()}const _=new class extends s{constructor(e){super(e),this._popupName=this._popup.querySelector(".popup__name"),this._popupImage=this._popup.querySelector(".popup__image")}open({name:e,link:t}){this._popupName.textContent=e,this._popupImage.src=t,this._popupImage.alt=e,super.open()}}("#popup-card");_.setEventListeners();const d=new class extends s{constructor({popupSelector:e,submitCallback:t}){super(e),this._submitButton=this._popup.querySelector(".form__save-button"),this._submitCallback=t}open(e){this.card=e,super.open()}setEventListeners(){this._submitButton.addEventListener("click",(()=>{this._submitCallback()})),super.setEventListeners()}}({popupSelector:"#popup-agreement",submitCallback:()=>{l.deleteCard(d.card._id).then((()=>d.card.deleteCard())).then((()=>d.close())).catch((e=>console.log(e)))}});d.setEventListeners();const p=new r({popupSelector:"#popup-profile",submitCallback:e=>{p.setPending(),l.changeUserInfo(e).then((e=>{c.setUserInfo(e),p.close()})).catch((e=>console.log(e))).finally((()=>p.removePending("Сохранить")))}});p.setEventListeners(),n.addEventListener("click",(e=>{l.getUserInfo(e).then((e=>{p.setInputValues(e)})),k.resetValidation(),k.toggleButtonState(),p.open()}));const m=new r({popupSelector:"#popup-avatar",submitCallback:e=>{m.setPending(),l.changeAvatar({avatar:e.avatar}).then((()=>{c.setAvatar({avatar:e.avatar}),m.close()})).catch((e=>console.log(e))).finally((()=>m.removePending("Сохранить")))}});m.setEventListeners(),a.addEventListener("click",(()=>{C.resetValidation(),C.toggleButtonState(),m.open()}));const v=new r({popupSelector:"#popup-place",submitCallback:e=>{v.setPending(),l.addCard(e).then((e=>{h.addItem(u(e,e.owner._id)),v.close()})).catch((e=>console.log(e))).finally((()=>v.removePending("Создать")))}});v.setEventListeners(),i.addEventListener("click",(()=>{b.resetValidation(),b.toggleButtonState(),v.open()}));const b=new t(o,"#place-form");b.enableValidation();const k=new t(o,"#profile-form");k.enableValidation();const C=new t(o,"#avatar-form");C.enableValidation(),Promise.all([l.getUserInfo(),l.getCardList()]).then((e=>{c.setAvatar(e[0]),console.log(e[0]),c.setUserInfo(e[0]),console.log(e[0]),h.renderItems(e[1].reverse())})).catch((e=>console.log(e)))})();